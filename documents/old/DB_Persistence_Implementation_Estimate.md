# DB永続化機能の実装に関する作業工数見積もり（進捗反映版）

## 1. 目的

このドキュメントは、MVP（最短デモ）開発完了後、`api_refactoring_guide.md`で定義されたデータベース永続化機能を実装するために必要な作業タスクを洗い出し、その工数を見積もることを目的とします。

## 2. 見積もり総括

**残りの作業工数**として、**合計で5〜8営業日程度**が見込まれます。

この見積もりには、新規コードの開発だけでなく、既存コードとの結合、単体・結合テスト、デバッグの時間も含まれています。

## 3. 作業タスクの内訳

**進捗状況 (2025-08-18現在):**
基本的なCRUD関数（`insert`, `read`, `update`, `delete`）の実装と、それに対応する単体テスト (`test_db_controller.py`) は完了しています。これは、DB永続化機能開発の**前提条件が整った**状態です。

以下に、これから着手する必要がある未実装タスクの内訳と工数を示します。

### フェーズ1: DBコントローラの機能拡張 (`utils/db_controller.py`)

- **内容:** 汎用的なCRUD操作に加え、`api.py`の複雑なデータ永続化ロジックをサポートするための高レベルな関数を実装します。
- **残見積もり:** **約2日**

| タスク ID | タスク内容 | 概要 | 進捗状況 | 残工数 |
| :--- | :--- | :--- | :--- | :--- |
| 1.1 | `get_or_create_company` | 会社情報を検索し、存在しなければ新規作成する冪等な関数を実装する。 | 未着手 | 0.5日 |
| 1.2 | `get_items_by_element_ids` | `element_id`のリストを基に、財務項目をDBから一括で効率的に検索する。 | 未着手 | 0.5日 |
| 1.3 | `bulk_insert_items` | 新規の財務項目マスターデータを、DBに一括で高速に挿入する。 | 未着手 | 0.5日 |
| 1.4 | `save_report_and_data` | 財務報告書と多数の財務データを、単一のトランザクション内でアトミックに保存する。 | 未着手 | 0.5日 |

### フェーズ2: APIの永続化ロジック実装 (`utils/api.py`)

- **内容:** データマッピングとDB永続化を統括するメインフローを実装します。
- **残見積もり:** **約2〜3日**

| タスク ID | タスク内容 | 概要 | 進捗状況 | 残工数 |
| :--- | :--- | :--- | :--- | :--- |
| 2.1 | `_financial_data_mapping` | DataFrameを走査し、`Financial_data`モデルに対応する辞書のリストを作成する。 | 未着手 | 0.5日 |
| 2.2 | `save_financial_bundle` | `api_refactoring_guide.md`の4.1節で定義されたメイン処理フローを実装する。 | 未着手 | 1.5〜2.5日 |

### フェーズ3: 統合テストとデバッグ

- **内容:** 実際のCSVデータを用いて、データ取得からDB永続化までの一連のパイプラインが、データの整合性を保ったまま正しく動作することを確認します。
- **残見積もり:** **約1〜3日**

| タスク ID | タスク内容 | 概要 | 進捗状況 | 残工数 |
| :--- | :--- | :--- | :--- | :--- |
| 3.1 | 統合テスト | 実際のCSVデータを使い、`save_financial_bundle`を実行し、DBの全テーブルのデータを確認する。 | 未着手 | 1〜2日 |
| 3.2 | デバッグ・修正 | テストで発見されたバグや、予期せぬデータ形式によるエラーを修正する。 | 未着手 | 0〜1日 |

## 4. 工数に影響する可能性のある要因（リスク）

- **データの多様性:** EDINETから取得されるCSVデータが、想定外の形式やカラムを含んでいた場合、マッピングロジックの修正に追加の工数が必要になる可能性があります。
- **パフォーマンス:** 大量のデータを一度に処理する場合、バルクインサートやクエリのパフォーマンスチューニングが必要になる可能性があります。
- **DBスキーマの変更:** 実装過程で、既存のDBスキーマ（`db_models.py`）に微修正が必要になる可能性があります。

## 5. 結論

上記のタスクを完了することで、プロジェクトは単なる一過性のデモから、**データを継続的に蓄積・活用できる持続可能な分析システムへと進化**します。この永続化基盤は、将来的な機能拡張（時系列分析、複数企業比較など）の礎となります。