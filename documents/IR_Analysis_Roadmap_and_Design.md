# IR分析プロジェクト 完成版ロードマップ・設計方針（統合版）

## 1. はじめに

本ドキュメントは、IR分析プロジェクトのMVP（Minimum Viable Product）から完成版へと進化させるための、開発ロードマップと設計方針を統合的にまとめたものです。  
PM・シニアエンジニア・スクラムマスターの視点から、2週間スプリント単位での優先タスク、アーキテクチャ、リファクタリング方針を明確化します。

---

## 2. 現状と課題

### 2.1. 現状（MVP版）

- 企業財務データのCSV直読による可視化（Streamlit UI）
- DBやAPI連携は未実装
- UIとデータ処理ロジックが密結合
- テスト・運用面は最小限

### 2.2. 主な課題

- データ永続化・取得のためのDB連携が未着手
- ビジネスロジックとデータアクセスの責務分離が不十分
- 拡張性・保守性・テスト容易性に課題
- 複数企業比較や期間選択など、分析機能の拡充が必要

---

## 3. 完成版に向けたアーキテクチャ方針

### 3.1. 3層構造の採用

- **View/Controller（app.py, Streamlit UI）**  
  ユーザー操作受付・結果表示のみを担当。Serviceレイヤーの呼び出しに特化。
- **Serviceレイヤー**  
  ビジネスロジック・DTO/DataFrame変換・トランザクション管理を担当。複数Repositoryを組み合わせてデータ加工・集計を行う。
- **Repositoryレイヤー**  
  SQLAlchemy ORMを用いたDBアクセスに特化。モデルオブジェクトのCRUD操作をカプセル化。

### 3.2. モデル設計の強化

- モデル間の`relationship`と`back_populates`を追加し、オブジェクト指向的な連携を強化
- 検索キーとなるカラムに`index`を追加し、パフォーマンス向上
- Upsert（Update or Insert）ロジックをRepositoryに実装

### 3.3. 責務分離とテスト容易性

- 各レイヤーの責務を明確化し、密結合を排除
- テストはモデルオブジェクトのプロパティ検証を中心に、トランザクション管理を徹底
- CI/CD（GitHub Actions）による自動テスト・ビルド

---

## 4. 2週間スプリント計画（優先タスク）

### スプリント1（1週目）

1. **設計方針の確定・ドキュメント整備**
   - 3層アーキテクチャの設計レビュー
   - README・設計書のアップデート

2. **DBモデルの強化**
   - `relationship`・`index`の追加
   - モデル定義のリファクタリング

3. **Repositoryパターン導入**
   - `db_controller.py`廃止、各モデルごとにRepositoryクラス新設
   - Upsert/トランザクション管理の実装

4. **Serviceレイヤー雛形作成**
   - ビジネスロジック層の新設
   - DTO/DataFrame変換の責務分離

5. **テスト基盤整備**
   - Repository単位のテスト刷新
   - トランザクション管理の徹底

---

### スプリント2（2週目）

1. **DB連携・永続化機能の実装**
   - Service→Repository→DBの流れで企業・財務データの保存・取得
   - マッピング関数のORMオブジェクト返却化

2. **UI/UXの拡張**
   - Streamlit UIのService呼び出し化
   - 企業選択・期間選択の拡張（DBから動的取得）

3. **分析機能の拡充**
   - 追加財務指標（キャッシュフロー、自己資本比率等）のグラフ化
   - 複数企業の比較表示

4. **テスト・CI/CD強化**
   - Service/Repository層の単体テスト追加
   - GitHub Actionsによる自動化

5. **運用・設定ガイドの追記**
   - Docker/ローカル環境切替、バッチ実行手順

---

## 5. リファクタリング方針（各ファイルの役割）

### 5.1. `db_models.py`
- モデル間の`relationship`追加
- インデックス設定
- オブジェクト指向設計の徹底

### 5.2. `db_controller.py` → Repositoryクラス群
- 手続き的関数群を廃止
- モデルごとのRepositoryクラス新設
- Upsert・トランザクション管理の実装

### 5.3. `api.py`
- DataFrameからモデルオブジェクトへのマッピングに責務集中
- DB操作はService/Repositoryに委譲

### 5.4. Serviceレイヤー
- ビジネスロジック・DTO/DataFrame変換
- 複数Repositoryの組み合わせ
- トランザクション管理

### 5.5. `app.py`
- UIロジックとデータ取得ロジックの分離
- Serviceレイヤー呼び出しによるデータ表示

---

## 6. テスト・運用面の強化

- モデルオブジェクトのプロパティ検証中心のテスト
- テストごとにトランザクションをロールバック
- CI/CDによる自動化
- 設定ファイルの環境自動切替
- バッチ実行・スケジュール化対応

---

## 7. 今後の拡張計画

- DB連携・永続化（PostgreSQL/SQLAlchemy）
- Serviceレイヤー導入による責務分離
- 企業選択の拡張（EDINETコード検索、DBから動的取得）
- 追加財務指標・複数企業比較・期間選択機能
- 単体テスト・例外処理・運用面の強化

---

## 8. 結論

本ロードマップと設計方針に沿って開発を進めることで、  
MVPから完成版への進化がスムーズに実現でき、  
拡張性・保守性・テスト容易性に優れたIR分析基盤を構築できます。

今後は「DB連携」「Serviceレイヤー導入」「企業選択の拡張」「分析機能の拡充」「テスト・運用面の強化」を優先的に進めてください。
